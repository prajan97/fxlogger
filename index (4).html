<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FX Transaction Logger</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      min-height: 100vh;
      background: #0a0e17;
      color: #e8ecf4;
      font-family: 'DM Sans', 'Segoe UI', system-ui, sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }
    input::placeholder { color: #334155; }
    select { color-scheme: dark; }

    .header {
      background: linear-gradient(135deg, #0f1523 0%, #141c2e 50%, #0f1523 100%);
      border-bottom: 1px solid rgba(99,179,237,0.08);
      padding: 16px 0;
    }
    .header-inner {
      max-width: 940px; margin: 0 auto; padding: 0 20px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .logo-group { display: flex; align-items: center; gap: 12px; }
    .logo-icon {
      width: 36px; height: 36px; border-radius: 10px;
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      display: flex; align-items: center; justify-content: center;
      font-size: 16px; font-weight: 700; color: #fff;
      font-family: 'DM Mono', monospace; flex-shrink: 0;
    }
    .logo-title { font-size: 17px; font-weight: 700; letter-spacing: -0.02em; color: #f0f4fc; }
    .logo-sub { font-size: 10px; color: #64748b; font-weight: 500; letter-spacing: 0.05em; text-transform: uppercase; margin-top: 1px; }
    .status { display: flex; align-items: center; gap: 6px; font-size: 11px; color: #475569; font-family: 'DM Mono', monospace; }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; transition: all 0.3s; flex-shrink: 0; }
    .status-dot.live { background: #22c55e; box-shadow: 0 0 8px rgba(34,197,94,0.4); }
    .status-dot.loading { background: #eab308; box-shadow: 0 0 8px rgba(234,179,8,0.4); }
    .status-dot.error { background: #ef4444; box-shadow: 0 0 8px rgba(239,68,68,0.4); }

    .main { max-width: 940px; margin: 0 auto; padding: 20px; }

    .tabs {
      display: flex; gap: 4px; margin-bottom: 24px;
      background: #111827; border-radius: 12px; padding: 4px;
      border: 1px solid rgba(99,179,237,0.06);
    }
    .tab-btn {
      flex: 1; padding: 12px 0; border: none; border-radius: 9px;
      font-size: 13px; font-weight: 600; cursor: pointer;
      transition: all 0.2s; font-family: inherit;
      background: transparent; color: #64748b;
    }
    .tab-btn.active {
      background: linear-gradient(135deg, #1e3a5f, #1a2744);
      color: #93c5fd; box-shadow: 0 2px 8px rgba(37,99,235,0.15);
    }

    .card {
      background: linear-gradient(145deg, #111827, #0f1623);
      border-radius: 16px; padding: 24px;
      border: 1px solid rgba(99,179,237,0.08);
    }
    .card + .card { margin-top: 14px; }
    .section-label {
      font-size: 13px; font-weight: 600; color: #93c5fd; margin-bottom: 14px;
      display: flex; align-items: center; gap: 8px;
    }
    .badge {
      font-size: 10px; padding: 2px 8px; border-radius: 6px; font-weight: 700; letter-spacing: 0.04em;
    }
    .badge.in { background: rgba(34,197,94,0.15); color: #4ade80; }
    .badge.out { background: rgba(239,68,68,0.12); color: #f87171; }

    .amount-row { display: flex; align-items: center; gap: 10px; }
    .currency-sign { font-size: 32px; font-weight: 300; color: #475569; font-family: 'DM Mono', monospace; }
    .amount-input {
      flex: 1; background: transparent; border: none; outline: none;
      font-size: 38px; font-weight: 300; color: #f0f4fc;
      font-family: 'DM Mono', monospace; letter-spacing: -0.02em; width: 100%;
      min-width: 0;
    }
    .currency-badge {
      font-size: 13px; font-weight: 600; color: #475569;
      padding: 6px 10px; background: rgba(99,179,237,0.06); border-radius: 8px; white-space: nowrap; flex-shrink: 0;
    }

    .live-conversion {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
      margin-top: 14px; padding-top: 14px;
      border-top: 1px solid rgba(99,179,237,0.06);
    }
    .live-conv-item { text-align: center; }
    .live-conv-label { font-size: 11px; color: #475569; margin-bottom: 3px; }
    .live-conv-value { font-size: 14px; font-weight: 600; color: #e2e8f0; font-family: 'DM Mono', monospace; }

    .fields-row { display: flex; gap: 10px; margin-bottom: 10px; }
    .fields-row > div { flex: 1; }
    .field-label { font-size: 12px; color: #475569; display: block; margin-bottom: 5px; font-weight: 500; }
    .field-input, .field-select {
      width: 100%; padding: 12px 14px; background: #0a0e17;
      border: 1px solid rgba(99,179,237,0.1); border-radius: 10px;
      color: #e2e8f0; font-size: 16px; outline: none;
      font-family: 'DM Sans', system-ui, sans-serif;
      transition: border-color 0.2s; color-scheme: dark;
      -webkit-appearance: none;
    }
    .field-input:focus, .field-select:focus { border-color: rgba(37,99,235,0.4); }

    .payee-card {
      background: rgba(0,0,0,0.2); border-radius: 12px; padding: 14px;
      margin-bottom: 10px; border: 1px solid rgba(99,179,237,0.04);
      position: relative;
    }
    .payee-row { display: flex; gap: 10px; align-items: flex-end; }
    .payee-row > div { flex: 1; }
    .payee-row > div.currency-col { flex: 0 0 120px; }
    .payee-row > div.converted-col { flex: 0 0 150px; }
    .converted-display {
      padding: 12px 14px; background: rgba(37,99,235,0.06);
      border: 1px solid rgba(37,99,235,0.12); border-radius: 10px;
      font-family: 'DM Mono', monospace; font-size: 14px; font-weight: 600;
      color: #93c5fd; min-height: 45px; display: flex; align-items: center;
    }
    .remove-payee {
      position: absolute; top: 10px; right: 10px;
      width: 28px; height: 28px; border-radius: 7px;
      background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.15);
      color: #64748b; font-size: 16px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; font-family: inherit;
    }
    .remove-payee:hover { background: rgba(239,68,68,0.2); color: #f87171; }
    .add-payee-btn {
      width: 100%; padding: 14px; border: 1px dashed rgba(99,179,237,0.15);
      border-radius: 10px; background: transparent; color: #64748b;
      font-size: 14px; font-weight: 600; cursor: pointer;
      font-family: inherit; transition: all 0.2s;
    }
    .add-payee-btn:hover { border-color: rgba(37,99,235,0.3); color: #93c5fd; }

    .log-btn {
      width: 100%; padding: 16px 0; border: none; border-radius: 12px;
      font-size: 15px; font-weight: 700; cursor: pointer;
      font-family: inherit; letter-spacing: 0.02em; transition: all 0.3s;
      margin-top: 18px;
    }
    .log-btn.active { background: linear-gradient(135deg, #2563eb, #7c3aed); color: #fff; box-shadow: 0 4px 20px rgba(37,99,235,0.3); }
    .log-btn.disabled { background: #1e293b; color: #475569; cursor: not-allowed; }

    .toast {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: linear-gradient(135deg, #065f46, #064e3b);
      color: #a7f3d0; padding: 14px 22px; border-radius: 12px;
      font-size: 14px; font-weight: 600;
      display: flex; align-items: center; gap: 10px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      border: 1px solid rgba(167,243,208,0.15);
      z-index: 999; animation: slideDown 0.3s ease-out;
      white-space: nowrap;
    }
    .toast-icon {
      width: 22px; height: 22px; border-radius: 50%; background: #22c55e;
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; color: #fff; flex-shrink: 0;
    }
    @keyframes slideDown {
      from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }

    /* Balance tracker */
    .balance-grid {
      display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;
      margin-bottom: 16px;
    }
    .balance-card {
      background: linear-gradient(145deg, #111827, #0f1623);
      border-radius: 12px; padding: 16px;
      border: 1px solid rgba(99,179,237,0.06);
    }
    .balance-label { font-size: 10px; color: #475569; text-transform: uppercase; letter-spacing: 0.08em; font-weight: 600; margin-bottom: 6px; }
    .balance-value { font-size: 18px; font-weight: 700; font-family: 'DM Mono', monospace; }
    .balance-value.green { color: #4ade80; }
    .balance-value.red { color: #f87171; }
    .balance-value.blue { color: #93c5fd; }
    .balance-sub { font-size: 10px; color: #475569; margin-top: 3px; font-family: 'DM Mono', monospace; }

    .summary-bar {
      background: linear-gradient(145deg, #111827, #0f1623);
      border-radius: 14px; padding: 14px 18px; margin-bottom: 14px;
      border: 1px solid rgba(99,179,237,0.06);
      display: flex; justify-content: space-between; align-items: center;
      flex-wrap: wrap; gap: 10px;
    }
    .summary-stats { display: flex; gap: 20px; flex-wrap: wrap; }
    .stat-label { font-size: 11px; color: #475569; text-transform: uppercase; letter-spacing: 0.08em; font-weight: 600; }
    .stat-value { font-size: 18px; font-weight: 700; font-family: 'DM Mono', monospace; margin-top: 2px; }
    .stat-value.highlight { color: #93c5fd; }
    .btn-group { display: flex; gap: 8px; }
    .export-btn, .print-btn {
      padding: 10px 16px;
      border: 1px solid rgba(37,99,235,0.2); border-radius: 10px;
      font-size: 13px; font-weight: 600;
      cursor: pointer; font-family: inherit; white-space: nowrap;
    }
    .export-btn { background: rgba(37,99,235,0.1); color: #93c5fd; }
    .print-btn { background: rgba(99,179,237,0.06); color: #94a3b8; border-color: rgba(99,179,237,0.12); }
    .search-row { display: flex; gap: 8px; margin-bottom: 14px; }
    .search-input {
      flex: 1; padding: 12px 14px; background: #111827;
      border: 1px solid rgba(99,179,237,0.08); border-radius: 10px;
      color: #e2e8f0; font-size: 14px; outline: none; font-family: inherit;
    }
    .sort-btn {
      padding: 12px 14px; background: #111827;
      border: 1px solid rgba(99,179,237,0.08); border-radius: 10px;
      color: #93c5fd; font-size: 13px; font-weight: 500;
      cursor: pointer; font-family: inherit; white-space: nowrap;
    }

    .tx-list { display: flex; flex-direction: column; gap: 8px; }
    .tx-item {
      background: #111827; border-radius: 14px;
      border: 1px solid rgba(99,179,237,0.04);
      overflow: hidden; transition: all 0.2s;
    }
    .tx-item.expanded { background: linear-gradient(145deg, #131b2e, #111827); border-color: rgba(37,99,235,0.2); }
    .tx-header {
      padding: 14px 16px; cursor: pointer;
      display: flex; justify-content: space-between; align-items: center;
      gap: 10px;
    }
    .tx-left { display: flex; align-items: center; gap: 12px; min-width: 0; }
    .tx-avatar {
      width: 38px; height: 38px; border-radius: 10px; flex-shrink: 0;
      background: rgba(34,197,94,0.1);
      display: flex; align-items: center; justify-content: center;
      font-size: 15px; font-weight: 700; color: #4ade80;
      font-family: 'DM Mono', monospace;
    }
    .tx-name { font-weight: 600; font-size: 14px; color: #e2e8f0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .tx-meta { font-size: 11px; color: #475569; margin-top: 2px; font-family: 'DM Mono', monospace; }
    .tx-right { text-align: right; flex-shrink: 0; }
    .tx-amount-received { font-weight: 700; font-size: 15px; color: #4ade80; font-family: 'DM Mono', monospace; }
    .tx-toggle { font-size: 11px; color: #475569; margin-top: 2px; }

    .tx-details { padding: 0 16px 16px; border-top: 1px solid rgba(99,179,237,0.06); padding-top: 14px; }
    .tx-flow-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 8px; }
    .tx-flow-label.in { color: #4ade80; }
    .tx-flow-label.out { color: #f87171; }
    .tx-receive-box {
      padding: 10px 14px; background: rgba(34,197,94,0.06); border-radius: 10px;
      margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;
    }
    .tx-receive-name { font-size: 13px; color: #e2e8f0; font-weight: 500; }
    .tx-receive-amount { font-size: 14px; font-weight: 600; color: #4ade80; font-family: 'DM Mono', monospace; }
    .tx-payee-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 14px; background: rgba(0,0,0,0.2); border-radius: 10px;
      margin-bottom: 6px;
    }
    .tx-payee-name { font-size: 13px; color: #e2e8f0; font-weight: 500; }
    .tx-payee-amount { font-size: 14px; font-weight: 600; color: #f87171; font-family: 'DM Mono', monospace; }

    .tx-actions { margin-top: 12px; display: flex; justify-content: flex-end; gap: 8px; }
    .delete-btn {
      padding: 8px 16px; background: transparent;
      border: 1px solid rgba(239,68,68,0.15); border-radius: 8px;
      color: #64748b; font-size: 13px; font-weight: 500;
      cursor: pointer; font-family: inherit;
    }
    .delete-confirm-btn {
      padding: 8px 16px; border-radius: 8px;
      font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit;
    }
    .delete-yes { background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.3); color: #ef4444; }
    .delete-cancel { background: rgba(99,179,237,0.06); border: 1px solid rgba(99,179,237,0.1); color: #64748b; }

    .empty-state { text-align: center; padding: 50px 20px; color: #475569; }
    .empty-icon { font-size: 36px; margin-bottom: 10px; opacity: 0.4; }
    .empty-title { font-size: 15px; font-weight: 600; }
    .empty-sub { font-size: 13px; margin-top: 4px; color: #334155; }

    .arrow-divider {
      display: flex; align-items: center; justify-content: center;
      padding: 10px 0; color: #334155; font-size: 18px;
    }

    .footer {
      text-align: center; margin-top: 32px; padding-bottom: 20px;
      font-size: 11px; color: #334155; font-family: 'DM Mono', monospace;
    }

    .hidden { display: none !important; }

    /* ===== MOBILE ===== */
    @media (max-width: 700px) {
      .main { padding: 16px; }
      .card { padding: 18px; border-radius: 14px; }
      .amount-input { font-size: 28px; }
      .currency-sign { font-size: 26px; }
      .header-inner { gap: 8px; }
      .logo-title { font-size: 15px; }
      .status { font-size: 10px; }
      .live-conversion { grid-template-columns: repeat(3, 1fr); gap: 6px; }
      .live-conv-value { font-size: 12px; }
      .fields-row { flex-direction: column; gap: 8px; }
      .payee-row { flex-direction: column; align-items: stretch; gap: 8px; }
      .payee-row > div.currency-col, .payee-row > div.converted-col { flex: 1; }
      .balance-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
      .balance-card { padding: 12px; }
      .balance-value { font-size: 15px; }
      .summary-bar { flex-direction: column; align-items: stretch; }
      .btn-group { display: flex; }
      .btn-group > * { flex: 1; text-align: center; }
      .search-row { flex-direction: column; }
      .tx-header { padding: 12px 14px; }
      .tx-details { padding: 0 14px 14px; padding-top: 12px; }
      .tab-btn { font-size: 12px; padding: 11px 0; }
      .tx-name { font-size: 13px; }
      .tx-amount-received { font-size: 14px; }
    }

    /* ===== PRINT ===== */
    @media print {
      body { background: #fff !important; color: #000 !important; font-size: 11pt; }
      .header, .tabs, .toast, .footer, #convertPanel, .search-row,
      .btn-group, .tx-toggle, .tx-actions, .delete-btn, .delete-confirm-btn,
      .add-payee-btn, .log-btn, .arrow-divider, .sort-btn { display: none !important; }

      .main { max-width: 100%; padding: 0; }

      .print-header {
        display: block !important;
        text-align: center; margin-bottom: 20pt; padding-bottom: 10pt;
        border-bottom: 2pt solid #000;
      }
      .print-header h1 { font-size: 18pt; font-weight: 700; margin-bottom: 4pt; }
      .print-header p { font-size: 10pt; color: #666; }

      .balance-grid { display: grid !important; grid-template-columns: repeat(4, 1fr); gap: 8pt; margin-bottom: 16pt; }
      .balance-card {
        background: none !important; border: 1pt solid #ccc !important;
        border-radius: 4pt; padding: 8pt;
      }
      .balance-label { color: #666 !important; }
      .balance-value { color: #000 !important; font-size: 13pt; }
      .balance-value.green { color: #166534 !important; }
      .balance-value.red { color: #991b1b !important; }
      .balance-value.blue { color: #1e40af !important; }
      .balance-sub { color: #666 !important; }

      .summary-bar { display: none !important; }
      #historyPanel { display: block !important; }

      .tx-list { gap: 0 !important; }
      .tx-item {
        background: none !important; border: none !important;
        border-bottom: 1pt solid #ddd !important; border-radius: 0 !important;
        page-break-inside: avoid;
      }
      .tx-item.expanded { background: none !important; }
      .tx-header { padding: 8pt 0; cursor: default; }
      .tx-avatar { display: none !important; }
      .tx-left { gap: 0 !important; }
      .tx-name { color: #000 !important; }
      .tx-name span { color: #666 !important; }
      .tx-meta { color: #666 !important; }
      .tx-amount-received { color: #166534 !important; }

      .tx-details {
        display: block !important; border-top: none !important;
        padding: 0 0 8pt 0 !important;
      }
      .tx-receive-box { background: #f0fdf4 !important; border-radius: 4pt; }
      .tx-receive-name { color: #000 !important; }
      .tx-receive-amount { color: #166534 !important; }
      .tx-flow-label.in { color: #166534 !important; }
      .tx-flow-label.out { color: #991b1b !important; }
      .tx-payee-row { background: #fef2f2 !important; border-radius: 4pt; }
      .tx-payee-name { color: #000 !important; }
      .tx-payee-amount { color: #991b1b !important; }
    }
  </style>
</head>
<body>

  <!-- Print-only header -->
  <div class="print-header" style="display:none">
    <h1>FX Transaction Report</h1>
    <p id="printDate"></p>
  </div>

  <div class="header">
    <div class="header-inner">
      <div class="logo-group">
        <div class="logo-icon">FX</div>
        <div>
          <div class="logo-title">FX Transaction Logger</div>
          <div class="logo-sub">THB â†’ USD Â· GBP Â· INR</div>
        </div>
      </div>
      <div class="status">
        <div class="status-dot loading" id="statusDot"></div>
        <span id="statusText">Fetching ratesâ€¦</span>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="tabs">
      <button class="tab-btn active" id="tabConvert" onclick="switchTab('convert')">New Transaction</button>
      <button class="tab-btn" id="tabHistory" onclick="switchTab('history')">History (0)</button>
    </div>

    <!-- New Transaction -->
    <div id="convertPanel">
      <div class="card">
        <div class="section-label"><span>Received</span><span class="badge in">IN</span></div>
        <div class="amount-row">
          <span class="currency-sign">à¸¿</span>
          <input type="number" class="amount-input" id="amountInput" placeholder="0.00" oninput="updateAll()" inputmode="decimal">
          <span class="currency-badge">ðŸ‡¹ðŸ‡­ THB</span>
        </div>
        <div class="live-conversion hidden" id="liveConversion">
          <div class="live-conv-item">
            <div class="live-conv-label">ðŸ‡ºðŸ‡¸ USD</div>
            <div class="live-conv-value" id="liveUSD">$0.00</div>
          </div>
          <div class="live-conv-item">
            <div class="live-conv-label">ðŸ‡¬ðŸ‡§ GBP</div>
            <div class="live-conv-value" id="liveGBP">Â£0.00</div>
          </div>
          <div class="live-conv-item">
            <div class="live-conv-label">ðŸ‡®ðŸ‡³ INR</div>
            <div class="live-conv-value" id="liveINR">â‚¹0.00</div>
          </div>
        </div>
        <div class="fields-row" style="margin-top:14px">
          <div>
            <label class="field-label">From (Sender)</label>
            <input type="text" class="field-input" id="senderInput" placeholder="e.g. Somchai">
          </div>
          <div>
            <label class="field-label">Date</label>
            <input type="date" class="field-input" id="dateInput">
          </div>
          <div>
            <label class="field-label">Reference #</label>
            <input type="text" class="field-input" id="refInput" placeholder="e.g. TXN-001">
          </div>
        </div>
      </div>

      <div class="arrow-divider">â–¼</div>

      <div class="card">
        <div class="section-label"><span>Pay Out</span><span class="badge out">OUT</span></div>
        <div id="payeesList"></div>
        <button class="add-payee-btn" onclick="addPayee()">+ Add payee</button>
      </div>

      <button class="log-btn disabled" id="logBtn" onclick="logTransaction()">Enter an amount to log</button>
    </div>

    <!-- History -->
    <div id="historyPanel" class="hidden">
      <!-- Balance Tracker -->
      <div class="balance-grid hidden" id="balanceGrid">
        <div class="balance-card">
          <div class="balance-label">Total In (THB)</div>
          <div class="balance-value green" id="balIn">à¸¿0.00</div>
          <div class="balance-sub" id="balTxCount">0 transactions</div>
        </div>
        <div class="balance-card">
          <div class="balance-label">Total Out (USD)</div>
          <div class="balance-value red" id="balUSD">$0.00</div>
        </div>
        <div class="balance-card">
          <div class="balance-label">Total Out (GBP)</div>
          <div class="balance-value red" id="balGBP">Â£0.00</div>
        </div>
        <div class="balance-card">
          <div class="balance-label">Total Out (INR)</div>
          <div class="balance-value red" id="balINR">â‚¹0.00</div>
        </div>
      </div>

      <div class="summary-bar hidden" id="summaryBar">
        <div class="summary-stats">
          <div>
            <div class="stat-label">Transactions</div>
            <div class="stat-value" id="txCount">0</div>
          </div>
        </div>
        <div class="btn-group">
          <button class="print-btn" onclick="printReport()">ðŸ–¨ Print</button>
          <button class="export-btn" onclick="exportCSV()">â†“ CSV</button>
        </div>
      </div>

      <div class="search-row hidden" id="searchRow">
        <input type="text" class="search-input" id="searchInput" placeholder="Search by name, ref, or date..." oninput="renderHistory()">
        <button class="sort-btn" id="sortBtn" onclick="toggleSort()">â†“ Newest</button>
      </div>

      <div id="txList"></div>
    </div>

    <div class="footer" id="footer">Rates: loadingâ€¦</div>
  </div>

  <div class="toast hidden" id="toast">
    <div class="toast-icon">âœ“</div>
    Transaction logged
  </div>

  <script>
    let rates = { USD: 0.0315, GBP: 0.023, INR: 2.845 };
    let ratesDate = null;
    let transactions = [];
    let sortOrder = 'newest';
    let expandedTx = null;
    let deleteConfirm = null;
    let payees = [];
    let payeeIdCounter = 0;

    const CUR = {
      USD: { name: 'US Dollar', symbol: '$', flag: 'ðŸ‡ºðŸ‡¸' },
      GBP: { name: 'British Pound', symbol: 'Â£', flag: 'ðŸ‡¬ðŸ‡§' },
      INR: { name: 'Indian Rupee', symbol: 'â‚¹', flag: 'ðŸ‡®ðŸ‡³' },
    };

    const fmt = (n) => new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);
    const genId = () => Math.random().toString(36).substr(2, 9);
    const esc = (s) => { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; };

    try { const s = localStorage.getItem('fx_transactions_v2'); if (s) transactions = JSON.parse(s); } catch(e) {}
    document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];

    fetch('https://api.frankfurter.dev/v1/latest?base=THB&symbols=USD,GBP,INR')
      .then(r => { if (!r.ok) throw new Error(); return r.json(); })
      .then(data => {
        rates = { USD: data.rates.USD, GBP: data.rates.GBP, INR: data.rates.INR };
        ratesDate = data.date;
        document.getElementById('statusDot').className = 'status-dot live';
        document.getElementById('statusText').textContent = 'Live Â· ' + data.date;
        updateRateDisplay(); updateAll();
      })
      .catch(() => {
        document.getElementById('statusDot').className = 'status-dot error';
        document.getElementById('statusText').textContent = 'Fallback rates';
        updateRateDisplay();
      });

    function updateRateDisplay() {
      const src = ratesDate ? 'Live via Frankfurter API' : 'Fallback rates';
      document.getElementById('footer').textContent =
        '1 THB = $' + rates.USD + ' Â· Â£' + rates.GBP + ' Â· â‚¹' + rates.INR + ' Â· ' + src;
    }

    function switchTab(tab) {
      document.getElementById('tabConvert').className = 'tab-btn' + (tab === 'convert' ? ' active' : '');
      document.getElementById('tabHistory').className = 'tab-btn' + (tab === 'history' ? ' active' : '');
      document.getElementById('convertPanel').className = tab === 'convert' ? '' : 'hidden';
      document.getElementById('historyPanel').className = tab === 'history' ? '' : 'hidden';
      if (tab === 'history') renderHistory();
    }

    function addPayee() {
      payees.push({ id: ++payeeIdCounter, name: '', currency: 'USD' });
      renderPayees();
    }

    function removePayee(id) {
      payees = payees.filter(p => p.id !== id);
      renderPayees(); updateAll();
    }

    function renderPayees() {
      const c = document.getElementById('payeesList');
      const thb = parseFloat(document.getElementById('amountInput').value) || 0;
      c.innerHTML = payees.map(p => {
        const info = CUR[p.currency];
        const conv = thb > 0 ? info.symbol + fmt(thb * rates[p.currency]) : 'â€”';
        return `
          <div class="payee-card">
            ${payees.length > 1 ? '<button class="remove-payee" onclick="removePayee('+p.id+')" title="Remove">Ã—</button>' : ''}
            <div class="payee-row">
              <div>
                <label class="field-label">Payee Name</label>
                <input type="text" class="field-input" value="${esc(p.name)}" placeholder="e.g. John"
                  oninput="updatePayeeName(${p.id}, this.value)">
              </div>
              <div class="currency-col">
                <label class="field-label">Currency</label>
                <select class="field-select" onchange="updatePayeeCurrency(${p.id}, this.value)">
                  <option value="USD" ${p.currency==='USD'?'selected':''}>ðŸ‡ºðŸ‡¸ USD</option>
                  <option value="GBP" ${p.currency==='GBP'?'selected':''}>ðŸ‡¬ðŸ‡§ GBP</option>
                  <option value="INR" ${p.currency==='INR'?'selected':''}>ðŸ‡®ðŸ‡³ INR</option>
                </select>
              </div>
              <div class="converted-col">
                <label class="field-label">They Receive</label>
                <div class="converted-display" id="pc_${p.id}">${conv}</div>
              </div>
            </div>
          </div>`;
      }).join('');
    }

    function updatePayeeName(id, v) { const p = payees.find(x => x.id === id); if (p) p.name = v; }
    function updatePayeeCurrency(id, v) { const p = payees.find(x => x.id === id); if (p) p.currency = v; updateAll(); }

    function updateAll() {
      const thb = parseFloat(document.getElementById('amountInput').value) || 0;
      const lc = document.getElementById('liveConversion');
      const btn = document.getElementById('logBtn');

      if (thb > 0) {
        lc.classList.remove('hidden');
        document.getElementById('liveUSD').textContent = '$' + fmt(thb * rates.USD);
        document.getElementById('liveGBP').textContent = 'Â£' + fmt(thb * rates.GBP);
        document.getElementById('liveINR').textContent = 'â‚¹' + fmt(thb * rates.INR);
      } else { lc.classList.add('hidden'); }

      payees.forEach(p => {
        const el = document.getElementById('pc_' + p.id);
        if (el) {
          const info = CUR[p.currency];
          el.textContent = thb > 0 ? info.symbol + fmt(thb * rates[p.currency]) : 'â€”';
        }
      });

      if (thb > 0) {
        btn.className = 'log-btn active';
        btn.textContent = 'Log Transaction â€” à¸¿' + fmt(thb);
      } else {
        btn.className = 'log-btn disabled';
        btn.textContent = 'Enter an amount to log';
      }
    }

    function logTransaction() {
      const thb = parseFloat(document.getElementById('amountInput').value) || 0;
      if (thb <= 0) return;
      const tx = {
        id: genId(),
        thbAmount: thb,
        sender: document.getElementById('senderInput').value || 'â€”',
        date: document.getElementById('dateInput').value,
        refNumber: document.getElementById('refInput').value || 'â€”',
        payees: payees.map(p => ({
          name: p.name || 'â€”',
          currency: p.currency,
          amount: thb * rates[p.currency],
        })),
        rates: { ...rates },
        timestamp: Date.now(),
      };
      transactions.unshift(tx);
      saveTransactions(); updateHistoryCount();

      document.getElementById('amountInput').value = '';
      document.getElementById('senderInput').value = '';
      document.getElementById('refInput').value = '';
      document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
      payees = []; addPayee(); updateAll();

      const toast = document.getElementById('toast');
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 2500);
    }

    function saveTransactions() {
      try { localStorage.setItem('fx_transactions_v2', JSON.stringify(transactions)); } catch(e) {}
    }

    function updateHistoryCount() {
      document.getElementById('tabHistory').textContent = 'History (' + transactions.length + ')';
    }

    function toggleSort() {
      sortOrder = sortOrder === 'newest' ? 'oldest' : 'newest';
      document.getElementById('sortBtn').textContent = sortOrder === 'newest' ? 'â†“ Newest' : 'â†‘ Oldest';
      renderHistory();
    }

    function calcBalances() {
      let totalTHB = 0, totalUSD = 0, totalGBP = 0, totalINR = 0;
      transactions.forEach(tx => {
        totalTHB += tx.thbAmount;
        tx.payees.forEach(p => {
          if (p.currency === 'USD') totalUSD += p.amount;
          else if (p.currency === 'GBP') totalGBP += p.amount;
          else if (p.currency === 'INR') totalINR += p.amount;
        });
      });
      return { totalTHB, totalUSD, totalGBP, totalINR };
    }

    function updateBalanceDisplay() {
      const b = calcBalances();
      const bg = document.getElementById('balanceGrid');
      if (transactions.length > 0) {
        bg.classList.remove('hidden');
        document.getElementById('balIn').textContent = 'à¸¿' + fmt(b.totalTHB);
        document.getElementById('balTxCount').textContent = transactions.length + ' transaction' + (transactions.length !== 1 ? 's' : '');
        document.getElementById('balUSD').textContent = '$' + fmt(b.totalUSD);
        document.getElementById('balGBP').textContent = 'Â£' + fmt(b.totalGBP);
        document.getElementById('balINR').textContent = 'â‚¹' + fmt(b.totalINR);
      } else { bg.classList.add('hidden'); }
    }

    function printReport() {
      // Expand all transactions for print
      const prevExpanded = expandedTx;
      document.querySelectorAll('.tx-item').forEach(el => el.classList.add('expanded'));
      // Temporarily show all details
      const allDetails = [];
      transactions.forEach(tx => {
        expandedTx = tx.id;
      });
      // Set print date
      document.getElementById('printDate').textContent =
        'Generated ' + new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
      // Re-render with all expanded
      const prevExpandedState = expandedTx;
      expandedTx = '__ALL__';
      renderHistory();
      setTimeout(() => {
        window.print();
        expandedTx = prevExpanded;
        renderHistory();
      }, 100);
    }

    function exportCSV() {
      if (!transactions.length) return;
      let rows = [['Date','Reference','Sender','THB Received','Payee','Currency','Amount Paid']];
      transactions.forEach(tx => {
        if (!tx.payees.length) {
          rows.push([tx.date,'"'+tx.refNumber+'"','"'+tx.sender+'"',tx.thbAmount.toFixed(2),'','','']);
        } else {
          tx.payees.forEach((p,i) => {
            rows.push([
              i===0?tx.date:'', i===0?'"'+tx.refNumber+'"':'', i===0?'"'+tx.sender+'"':'',
              i===0?tx.thbAmount.toFixed(2):'', '"'+p.name+'"', p.currency, p.amount.toFixed(2)
            ]);
          });
        }
      });
      const csv = rows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url;
      a.download = 'fx_transactions_' + new Date().toISOString().split('T')[0] + '.csv';
      a.click(); URL.revokeObjectURL(url);
    }

    function deleteTx(id) {
      transactions = transactions.filter(t => t.id !== id);
      saveTransactions(); updateHistoryCount();
      expandedTx = null; deleteConfirm = null; renderHistory();
    }

    function renderHistory() {
      updateBalanceDisplay();
      const search = (document.getElementById('searchInput').value || '').toLowerCase();
      let filtered = transactions.filter(t =>
        t.sender.toLowerCase().includes(search) ||
        t.refNumber.toLowerCase().includes(search) ||
        t.date.includes(search) ||
        t.payees.some(p => p.name.toLowerCase().includes(search))
      );
      filtered.sort((a, b) => sortOrder === 'newest' ? b.timestamp - a.timestamp : a.timestamp - b.timestamp);

      const sb = document.getElementById('summaryBar');
      const sr = document.getElementById('searchRow');
      if (transactions.length > 0) {
        sb.classList.remove('hidden'); sr.classList.remove('hidden');
        document.getElementById('txCount').textContent = transactions.length;
      } else { sb.classList.add('hidden'); sr.classList.add('hidden'); }

      const list = document.getElementById('txList');
      if (!filtered.length) {
        list.innerHTML = `<div class="empty-state"><div class="empty-icon">ðŸ“‹</div>
          <div class="empty-title">${!transactions.length ? 'No transactions yet' : 'No matching transactions'}</div>
          <div class="empty-sub">${!transactions.length ? 'Log your first transaction to get started' : 'Try adjusting your search'}</div></div>`;
        return;
      }

      const showAll = expandedTx === '__ALL__';

      list.innerHTML = '<div class="tx-list">' + filtered.map(tx => {
        const isExp = showAll || expandedTx === tx.id;
        const isDel = deleteConfirm === tx.id;
        const payeeNames = tx.payees.length ? ' â†’ ' + tx.payees.map(p => p.name).join(', ') : '';
        return `
          <div class="tx-item${isExp ? ' expanded' : ''}">
            <div class="tx-header" onclick="expandedTx=expandedTx==='${tx.id}'?null:'${tx.id}';deleteConfirm=null;renderHistory();">
              <div class="tx-left">
                <div class="tx-avatar">${tx.sender.charAt(0).toUpperCase()}</div>
                <div style="min-width:0">
                  <div class="tx-name">${esc(tx.sender)}${payeeNames ? ' <span style="color:#64748b;font-weight:400;font-size:11px">'+esc(payeeNames)+'</span>' : ''}</div>
                  <div class="tx-meta">${esc(tx.date)} Â· ${esc(tx.refNumber)}</div>
                </div>
              </div>
              <div class="tx-right">
                <div class="tx-amount-received">+à¸¿${fmt(tx.thbAmount)}</div>
                <div class="tx-toggle">${isExp?'â–²':'â–¼'} Details</div>
              </div>
            </div>
            ${isExp ? `
              <div class="tx-details">
                <div class="tx-flow-label in">Received</div>
                <div class="tx-receive-box">
                  <div class="tx-receive-name">ðŸ‡¹ðŸ‡­ From ${esc(tx.sender)}</div>
                  <div class="tx-receive-amount">+à¸¿${fmt(tx.thbAmount)}</div>
                </div>
                ${tx.payees.length ? `
                  <div class="tx-flow-label out" style="margin-top:10px">Paid Out</div>
                  ${tx.payees.map(p => {
                    const info = CUR[p.currency];
                    return `<div class="tx-payee-row">
                      <div class="tx-payee-name">${info.flag} ${esc(p.name)}</div>
                      <div class="tx-payee-amount">-${info.symbol}${fmt(p.amount)}</div>
                    </div>`;
                  }).join('')}
                ` : '<div style="font-size:13px;color:#475569;margin-top:8px">No payees recorded</div>'}
                <div class="tx-actions">
                  ${isDel ? `
                    <span style="font-size:12px;color:#ef4444;display:flex;align-items:center">Delete?</span>
                    <button class="delete-confirm-btn delete-yes" onclick="event.stopPropagation();deleteTx('${tx.id}')">Yes</button>
                    <button class="delete-confirm-btn delete-cancel" onclick="event.stopPropagation();deleteConfirm=null;renderHistory()">Cancel</button>
                  ` : `
                    <button class="delete-btn" onclick="event.stopPropagation();deleteConfirm='${tx.id}';renderHistory()">Delete</button>
                  `}
                </div>
              </div>
            ` : ''}
          </div>`;
      }).join('') + '</div>';
    }

    addPayee();
    updateHistoryCount();
    updateRateDisplay();
  </script>
</body>
</html>
